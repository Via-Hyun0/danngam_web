### 5.1 Firestore Collections

#### Collection: UserProfiles

|Field|Type|Description|Constraints|Index|
|---|---|---|---|---|
|userId|string|Firebase Auth UID (Document ID)|PK, Not Null|Yes|
|kakaoId|string|카카오 고유 ID|Unique, Optional|Yes|
|appleId|string|Apple 고유 ID|Unique, Optional|Yes|
|email|string|이메일 (선택)|Optional|No|
|nickname|string|닉네임 (랜덤 키워드 조합)|Not Null, Unique|Yes|
|nicknameKeywords|map|닉네임 생성 시 사용한 키워드|{adjective: string, noun: string}|No|
|displayName|string|UI 표시용 (기본값 = nickname)|Not Null|No|
|~~role~~|~~string~~|**제거됨 (v1.7)** - 역할 구분 없음||~~Yes~~|
|region|string|주요 활동 지역 (시/군)|Optional|Yes (for filtering)|
|fcmToken|string|FCM 푸시 알림 토큰|Optional, 로그인 시 업데이트|No|
|createdAt|timestamp|가입 일시|Not Null|Yes|
|lastActiveAt|timestamp|마지막 활동 일시|Not Null|No|
|isActive|boolean|계정 활성 상태 (정지 시 false)|Default: true|Yes|
|reportCount|number|신고 누적 수|Default: 0|No|

**Indexes:**

- kakaoId (unique)
- appleId (unique)
- nickname (unique)
- region (for filtering)
- isActive

**변경 사항 (v1.7):**

- `role` 필드 제거: 누구나 일감 등록/참여 가능

#### Collection: Jobs

|Field|Type|Description|Constraints|Index|
|---|---|---|---|---|
|jobId|string|일감 ID (Document ID)|PK, Auto-generated|Yes|
|creatorId|string|등록한 사용자 UID|Not Null, FK → UserProfiles.userId|Yes|
|creatorName|string|작성자 닉네임|Not Null|No|
|cropType|string|작물 종류|Enum: 12개 작물, Not Null|Yes|
|title|string|일감 제목|Not Null, Max: 100 chars|No|
|description|string|일감 상세 내용|Optional, Max: 500 chars|No|
|startDate|string|일감 시작일|Format: "YYYY-MM-DD", Not Null|No|
|endDate|string|일감 종료일|Format: "YYYY-MM-DD", Not Null|No|
|payType|string|급여 유형|Enum: 'daily', 'hourly', Not Null|No|
|payAmount|number|급여 금액|Not Null, Min: 0|Yes (range queries)|
|location|map|위치 정보|{ latitude: number, longitude: number, address: string }, Not Null|No|
|geohash|string|위치 기반 쿼리용 geohash|생성 시 자동 계산, Not Null|Yes|
|status|string|일감 상태|Enum: 'active', 'contracted', 'deleted', Default: 'active'|Yes|
|viewCount|number|조회 수|Default: 0|No|
|conversationCount|number|총 대화 수|Default: 0|No|
|images|array|사진 URL 배열|Optional, Max: 3 items|No|
|createdAt|timestamp|등록 일시|Not Null|Yes|
|updatedAt|timestamp|수정 일시|Not Null|No|

**Indexes:**

- creatorId + status
- geohash + status + createdAt (composite)
- cropType + status
- status + createdAt

**변경 사항 (v1.7):**

- `farmerId` → `creatorId`: 용어 변경
- `farmerName` → `creatorName`: 용어 변경
- `status` enum 확장:
    - `active`: 모집중
    - `contracted`: 계약 완료 (신규)
    - `deleted`: 삭제됨
    - Phase 2: `in_progress`, `completed`, `reviewed`, `cancelled` 추가 예정

#### Collection: Conversations

|Field|Type|Description|Constraints|Index|
|---|---|---|---|---|
|conversationId|string|대화방 ID (Document ID)|PK, Auto-generated|Yes|
|participants|array|참여자 UID 배열|[userId1, userId2] (정확히 2개)|Yes|
|jobId|string|일감 ID|Not Null, FK → Jobs.jobId|Yes|
|lastMessage|map|마지막 메시지 정보|{text: string, senderId: string, timestamp: Timestamp}|No|
|unreadCount|map|읽지 않은 메시지 수|{[userId: string]: number}|No|
|createdAt|timestamp|대화방 생성 일시|Not Null|Yes|
|updatedAt|timestamp|마지막 업데이트 일시|Not Null|Yes|

**Indexes:**

- participants (array-contains) + updatedAt (desc)
- jobId + participants (composite)

**Business Rules:**

- participants + jobId 조합은 unique (Firestore Transactions로 보장)
- participants 배열은 정확히 2개 userId만 포함
- 첫 대화방 생성 시 lastMessage는 null

#### Collection: Messages

|Field|Type|Description|Constraints|Index|
|---|---|---|---|---|
|messageId|string|메시지 ID (Document ID)|PK, Auto-generated|Yes|
|conversationId|string|대화방 ID|Not Null, FK → Conversations.conversationId|Yes|
|senderId|string|발신자 UID|Not Null, FK → UserProfiles.userId|Yes|
|messageType|string|메시지 타입|Enum: 'text', 'contract', 'system', Default: 'text'|Yes|
|text|string|메시지 내용|Not Null (text 타입), Max: 500 chars|No|
|contractId|string|계약서 ID (contract 타입)|Optional, FK → Contracts.contractId|Yes|
|timestamp|timestamp|전송 일시|Not Null|Yes|
|status|string|메시지 상태|Enum: 'sent', Default: 'sent'|No|

**Indexes:**

- conversationId + timestamp (asc)
- messageType + conversationId

**Business Rules:**

- text 길이: 1~500자 (text 타입)
- senderId는 conversation.participants에 포함되어야 함 (Security Rules)
- v1.0은 'sent' 상태만 지원 (추후 'delivered', 'read' 추가)

**변경 사항 (v1.7):**

- `messageType` 필드 추가: 일반 메시지와 계약서 메시지 구분
- `contractId` 필드 추가: 계약서 메시지인 경우 계약서 ID 참조

#### Collection: Contracts (신규 - v1.7)

|Field|Type|Description|Constraints|Index|
|---|---|---|---|---|
|contractId|string|계약서 ID (Document ID)|PK, Auto-generated|Yes|
|conversationId|string|대화방 ID|Not Null, FK → Conversations.conversationId|Yes|
|jobId|string|일감 ID|Not Null, FK → Jobs.jobId|Yes|
|creatorId|string|일감 작성자 UID|Not Null, FK → UserProfiles.userId|Yes|
|participantId|string|일감 참여자 UID|Not Null, FK → UserProfiles.userId|Yes|
|jobTitle|string|일감 제목|Not Null|No|
|cropType|string|작물 종류|Not Null|No|
|workPeriod|map|작업 기간|{startDate: string, endDate: string}, Not Null|No|
|payType|string|급여 유형|Enum: 'daily', 'hourly', Not Null|No|
|payAmount|number|급여 금액|Not Null, Min: 0|No|
|workDetails|string|작업 내용|Not Null, Max: 500 chars|No|
|specialNotes|string|특이사항|Optional, Max: 300 chars|No|
|status|string|계약 상태|Enum: 'pending', 'signed_by_creator', 'signed_by_both', Default: 'pending'|Yes|
|creatorSignature|map|작성자 서명|{signed: boolean, signedAt: timestamp \| null}|No|
|participantSignature|map|참여자 서명|{signed: boolean, signedAt: timestamp \| null}|No|
|createdAt|timestamp|계약서 생성 일시|Not Null|Yes|
|completedAt|timestamp|양측 서명 완료 일시|Optional|No|

**Indexes:**

- conversationId + status
- jobId + status
- creatorId + status
- participantId + status
- status + createdAt

**Business Rules:**

- 대화방당 1개의 활성 계약서만 가능 (status != 'cancelled')
- 양측 서명 완료 시 일감 상태 `active` → `contracted` 전환
- 계약서는 작성자만 생성 가능
- 서명 후 계약 내용 수정 불가

#### Collection: Events

|Field|Type|Description|Constraints|Index|
|---|---|---|---|---|
|eventId|string|이벤트 ID (Document ID)|PK, Auto-generated|Yes|
|eventType|string|이벤트 타입|Enum: 'job_created', 'job_view', 'message_sent', 'contract_created', 'contract_signed', Not Null|Yes|
|userId|string|발생시킨 사용자 UID|Not Null|Yes|
|jobId|string|관련 일감 ID|Nullable|Yes|
|conversationId|string|관련 대화방 ID|Nullable|Yes|
|contractId|string|관련 계약서 ID|Nullable|Yes|
|timestamp|timestamp|이벤트 발생 일시|Not Null|Yes|
|metadata|map|추가 정보 (이벤트별 다름)|Optional|No|

**Indexes:**

- eventType + timestamp
- userId + eventType + timestamp
- jobId + eventType
- contractId + eventType

**Usage:** 사용자 행동 분석, KPI 측정

**변경 사항 (v1.7):**

- `contract_created`, `contract_signed` 이벤트 타입 추가
- `contractId` 필드 추가

#### Collection: Reports

|Field|Type|Description|Constraints|Index|
|---|---|---|---|---|
|reportId|string|신고 ID (Document ID)|PK, Auto-generated|Yes|
|reporterId|string|신고자 UID|Not Null|Yes|
|targetType|string|신고 대상 타입|Enum: 'job', 'user', 'message', Not Null|Yes|
|targetId|string|신고 대상 ID|Not Null|Yes|
|reason|string|신고 사유|Enum: '허위 정보', '스팸', '부적절한 연락', '기타', Not Null|No|
|description|string|상세 내용|Optional, Max: 500 chars|No|
|status|string|처리 상태|Enum: 'pending', 'reviewed', 'resolved', Default: 'pending'|Yes|
|createdAt|timestamp|신고 일시|Not Null|Yes|

**Indexes:**

- reporterId + createdAt
- targetType + targetId + status (composite) - 동일 대상 신고 조회
- status + createdAt

### 5.2 Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // UserProfiles
    match /userProfiles/{userId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false; // 삭제는 Cloud Function에서만
    }
    
    // Jobs
    match /jobs/{jobId} {
      allow read: if true; // 모든 사용자 조회 가능
      allow create: if isAuthenticated() &&
                       request.resource.data.creatorId == request.auth.uid &&
                       request.resource.data.status == 'active';
      allow update: if isAuthenticated() &&
                       isOwner(resource.data.creatorId);
      allow delete: if isOwner(resource.data.creatorId);
    }
    
    // Conversations
    match /conversations/{conversationId} {
      // 참여자만 읽기 가능
      allow read: if request.auth.uid in resource.data.participants;
      
      // 본인이 participants에 포함된 경우만 생성 가능
      allow create: if request.auth.uid in request.resource.data.participants
                    && request.resource.data.participants.size() == 2
                    && request.auth.uid != request.resource.data.participants[0] 
                       || request.auth.uid != request.resource.data.participants[1]; // 자기 자신과 대화 방지
      
      // 참여자만 업데이트 가능 (lastMessage, unreadCount)
      allow update: if request.auth.uid in resource.data.participants;
    }
    
    // Messages
    match /messages/{messageId} {
      // 대화 참여자만 읽기 가능
      allow read: if request.auth != null
                    && exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId))
                    && request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participants;
      
      // 본인만 메시지 생성 가능 + 텍스트 길이 제한
      allow create: if request.auth.uid == request.resource.data.senderId
                    && (request.resource.data.messageType == 'text' 
                        && request.resource.data.text.size() >= 1
                        && request.resource.data.text.size() <= 500
                        || request.resource.data.messageType != 'text')
                    && exists(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId));
    }
    
    // Contracts (신규 - v1.7)
    match /contracts/{contractId} {
      // 참여자만 읽기 가능
      allow read: if request.auth.uid == resource.data.creatorId
                    || request.auth.uid == resource.data.participantId;
      
      // 일감 작성자만 계약서 생성 가능
      allow create: if request.auth.uid == request.resource.data.creatorId
                    && exists(/databases/$(database)/documents/jobs/$(request.resource.data.jobId))
                    && get(/databases/$(database)/documents/jobs/$(request.resource.data.jobId)).data.creatorId == request.auth.uid;
      
      // 참여자만 서명 가능 (자신의 서명 필드만 수정)
      allow update: if (request.auth.uid == resource.data.creatorId
                        && request.resource.data.creatorSignature.signed != resource.data.creatorSignature.signed)
                    || (request.auth.uid == resource.data.participantId
                        && request.resource.data.participantSignature.signed != resource.data.participantSignature.signed);
    }
    
    // Events (읽기 금지, 생성만 허용)
    match /events/{eventId} {
      allow read: if false; // 관리자만 조회 (Admin SDK)
      allow create: if isAuthenticated();
    }
    
    // Reports
    match /reports/{reportId} {
      allow create: if isAuthenticated();
      allow read: if isOwner(resource.data.reporterId);
      allow update: if false; // 수정 불가
    }
  }
}
```

### 5.3 Technology Stack

|Layer|Technology|Version|Purpose|
|---|---|---|---|
|**Frontend**|Flutter|3.16+|iOS/Android 크로스 플랫폼 개발|
|**State Management**|Riverpod|2.x|타입 세이프 상태 관리|
|**Backend**|Firebase|-|BaaS (Backend as a Service)|
|**Authentication**|Firebase Authentication|-|카카오/Apple 로그인 + Custom Token|
|**Database**|Cloud Firestore|-|NoSQL 문서 데이터베이스|
|**Storage**|Firebase Storage|-|이미지 저장|
|**Cloud Functions**|Firebase Cloud Functions|Node.js 18|서버리스 백엔드 로직<br>(필수 기능 + 상황별 활용)|
|**Push Notifications**|Firebase Cloud Messaging (FCM)|-|푸시 알림|
|**Analytics**|Firebase Analytics|-|사용자 행동 분석|
|**Crash Reporting**|Firebase Crashlytics|-|크래시 추적|
|**Maps**|Google Maps Platform|-|지도 표시 및 위치 기반 서비스|
|**Geolocation**|GeoFlutterFire|Latest|위치 기반 쿼리|
|**Image Handling**|image_picker, image|Latest|이미지 선택 및 압축|

#### State Management: Riverpod 2.x 선택 이유

|항목|설명|
|---|---|
|**Type Safety**|컴파일 타임에 모든 의존성 검증|
|**Code Generation**|@riverpod 어노테이션 기반 코드 자동 생성|
|**Dev Tools**|Riverpod Inspector로 실시간 상태 디버깅|
|**Testing**|Provider 오버라이드로 간편한 테스트 작성|
|**Performance**|선택적 리빌드로 불필요한 렌더링 최소화|

#### Cloud Functions 활용 전략

|사용 시나리오|필수 여부|구현 시기|
|---|---|---|
|카카오 로그인 Custom Token 생성|필수|Week 1|
|메시지 푸시 알림 발송|필수|Week 3|
|계약서 양측 서명 완료 시 일감 상태 변경|필수|Week 4|
|신고 자동 처리|필수|Week 5|
|AI 답변 생성 (OpenAI API)|선택|Phase 2|
|Rate Limiting 서버 검증|선택|Phase 3+ (필요 시)|
|데이터 분석 배치 작업|선택|Phase 5+ (필요 시)|
|복잡한 비즈니스 로직|선택|상황별 판단|

### 5.4 API Specifications

#### API-001: createKakaoCustomToken (Cloud Function)

|Attribute|Details|
|---|---|
|**Type**|Callable Cloud Function|
|**Caller**|Flutter 앱|
|**Input**|kakaoAccessToken|
|**Processing**|1. Kakao Access Token 검증<br>2. Kakao API로 사용자 정보 조회<br>3. Firebase Custom Token 생성<br>4. UserProfile 생성/업데이트 (닉네임 자동 생성)|
|**Output**|customToken 또는 Error|
|**Errors**|- INVALID_TOKEN: 유효하지 않은 카카오 토큰<br>- KAKAO_API_ERROR: 카카오 API 오류<br>- FIREBASE_ERROR: Firebase 토큰 생성 실패|

#### API-002: sendMessage

|Attribute|Details|
|---|---|
|**Type**|Client-side Firestore Write|
|**Caller**|사용자 앱|
|**Input**|conversationId, senderId, text, messageType|
|**Processing**|1. 대화방 존재 확인<br>2. Messages 문서 생성<br>3. Conversations.lastMessage 업데이트<br>4. unreadCount 증가<br>5. 수신자에게 FCM 푸시 발송 (Cloud Function 트리거)|
|**Output**|messageId 또는 Error|
|**Errors**|- CONVERSATION_NOT_FOUND: 대화방 없음<br>- TEXT_TOO_LONG: 메시지 길이 초과<br>- PERMISSION_DENIED: 권한 없음<br>- SELF_MESSAGE: 자신에게 메시지 불가|

#### API-003: sendMessageNotification (Cloud Function)

|Attribute|Details|
|---|---|
|**Type**|Firestore Trigger Cloud Function|
|**Trigger**|Messages 문서 생성 시|
|**Processing**|1. 수신자 FCM 토큰 조회<br>2. 푸시 알림 발송 (메시지 내용 포함)<br>3. 실패 시 재시도 (최대 3회)|
|**Output**|발송 결과|

#### API-004: createContract (신규 - v1.7)

|Attribute|Details|
|---|---|
|**Type**|Client-side Firestore Write + Cloud Function Trigger|
|**Caller**|일감 작성자 앱|
|**Input**|conversationId, jobId, workPeriod, payType, payAmount, workDetails, specialNotes|
|**Processing**|1. 일감 존재 및 권한 확인<br>2. Contracts 문서 생성<br>3. 계약서 메시지를 대화방에 전송<br>4. 상대방에게 푸시 알림 발송|
|**Output**|contractId 또는 Error|
|**Errors**|- JOB_NOT_FOUND: 일감 없음<br>- PERMISSION_DENIED: 작성자가 아님<br>- ACTIVE_CONTRACT_EXISTS: 이미 활성 계약서 존재|

#### API-005: signContract (신규 - v1.7)

|Attribute|Details|
|---|---|
|**Type**|Client-side Firestore Write + Cloud Function Trigger|
|**Caller**|계약 참여자 앱|
|**Input**|contractId, userId|
|**Processing**|1. 계약서 존재 및 권한 확인<br>2. 해당 사용자의 서명 필드 업데이트<br>3. 양측 서명 완료 시 일감 상태 `contracted`로 변경 (Cloud Function)<br>4. 상대방에게 푸시 알림 발송|
|**Output**|서명 완료 또는 Error|
|**Errors**|- CONTRACT_NOT_FOUND: 계약서 없음<br>- PERMISSION_DENIED: 권한 없음<br>- ALREADY_SIGNED: 이미 서명함|

#### API-006: updateJobStatusOnContract (Cloud Function - 신규 v1.7)

|Attribute|Details|
|---|---|
|**Type**|Firestore Trigger Cloud Function|
|**Trigger**|Contracts 문서의 양측 서명 완료 시|
|**Processing**|1. 계약서의 jobId 확인<br>2. Jobs 문서의 status를 'contracted'로 변경<br>3. 양측 참여자에게 계약 확정 푸시 알림 발송|
|**Output**|일감 상태 변경 완료|

#### API-007: generateAIReply (Cloud Function, Phase 2)

|Attribute|Details|
|---|---|
|**Type**|Callable Cloud Function|
|**Caller**|Flutter 앱|
|**Input**|conversationId|
|**Processing**|1. 최근 5개 메시지 조회<br>2. OpenAI API 호출<br>3. 3개 답변 옵션 생성|
|**Output**|답변 옵션 배열 또는 Error|
|**Errors**|- RATE_LIMIT_EXCEEDED: 하루 10회 초과<br>- OPENAI_ERROR: OpenAI API 오류<br>- CONVERSATION_NOT_FOUND: 대화방 없음|

#### API-008: handleReports (Cloud Function)

|Attribute|Details|
|---|---|
|**Type**|Firestore Trigger Cloud Function|
|**Trigger**|Reports 문서 생성 시|
|**Processing**|1. 동일 대상 신고 수 확인<br>2. 3건 이상 시 자동 조치<br> - user → isActive=false<br> - job → status='deleted'<br> - message → 대화방 차단<br>3. 관리자에게 이메일 발송|
|**Output**|조치 결과|

---