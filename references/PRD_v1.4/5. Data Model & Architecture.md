### 5.1 Firestore Collections

#### Collection: UserProfiles

| Field                   | Type      | Description                     | Constraints                        | Index               |
| ----------------------- | --------- | ------------------------------- | ---------------------------------- | ------------------- |
| userId                  | string    | Firebase Auth UID (Document ID) | PK, Not Null                       | Yes                 |
| phoneNumber             | string    | 전화번호 (+82 형식)             | Unique, Not Null                   | Yes                 |
| role                    | string    | 역할 (농부/작업자)              | Enum: 'farmer', 'worker', Not Null | Yes                 |
| nickname                | string    | 닉네임                          | Optional, Default: auto-generated  | No                  |
| region                  | string    | 주요 활동 지역 (시/군)          | Optional                           | Yes (for filtering) |
| defaultAvailableFrom    | string    | 기본 전화 가능 시작 시간 (24h)  | Optional, Format: "HH:mm"          | No                  |
| defaultAvailableTo      | string    | 기본 전화 가능 종료 시간 (24h)  | Optional, Format: "HH:mm"          | No                  |
| contactRequestsSent     | number    | 보낸 연락 요청 수 (제한용)      | Default: 0                         | No                  |
| contactRequestsAccepted | number    | 수락된 요청 수 (통계)           | Default: 0                         | No                  |
| fcmToken                | string    | FCM 푸시 알림 토큰              | Optional, 로그인 시 업데이트       | No                  |
| createdAt               | timestamp | 가입 일시                       | Not Null                           | Yes                 |
| lastActiveAt            | timestamp | 마지막 활동 일시                | Not Null                           | No                  |
| isActive                | boolean   | 계정 활성 상태 (정지 시 false)  | Default: true                      | Yes                 |
| reportCount             | number    | 신고 누적 수                    | Default: 0                         | No                  |

**Indexes:**

- phoneNumber (unique)
- role + region (composite)
- isActive

#### Collection: Jobs

| Field               | Type      | Description              | Constraints                                                        | Index               |
| ------------------- | --------- | ------------------------ | ------------------------------------------------------------------ | ------------------- |
| jobId               | string    | 작업 ID (Document ID)    | PK, Auto-generated                                                 | Yes                 |
| farmerId            | string    | 등록한 농부 UID          | Not Null, FK → UserProfiles.userId                                 | Yes                 |
| farmerPhone         | string    | 농부 전화번호            | Not Null                                                           | No                  |
| farmerName          | string    | 농부 닉네임              | Not Null                                                           | No                  |
| cropType            | string    | 작물 종류                | Enum: 12개 작물, Not Null                                          | Yes                 |
| title               | string    | 작업 제목                | Not Null, Max: 100 chars                                           | No                  |
| description         | string    | 작업 상세 내용           | Optional, Max: 500 chars                                           | No                  |
| startDate           | string    | 작업 시작일              | Format: "YYYY-MM-DD", Not Null                                     | No                  |
| endDate             | string    | 작업 종료일              | Format: "YYYY-MM-DD", Not Null                                     | No                  |
| payType             | string    | 급여 유형                | Enum: 'daily', 'hourly', Not Null                                  | No                  |
| payAmount           | number    | 급여 금액                | Not Null, Min: 0                                                   | Yes (range queries) |
| farmerAvailableFrom | string    | 농부 전화 가능 시작 시간 | Format: "HH:mm", Not Null                                          | No                  |
| farmerAvailableTo   | string    | 농부 전화 가능 종료 시간 | Format: "HH:mm", Not Null                                          | No                  |
| location            | map       | 위치 정보                | { latitude: number, longitude: number, address: string }, Not Null | No                  |
| geohash             | string    | 위치 기반 쿼리용 geohash | 생성 시 자동 계산, Not Null                                        | Yes                 |
| status              | string    | 작업 상태                | Enum: 'active', 'deleted', Default: 'active'                       | Yes                 |
| viewCount           | number    | 조회 수                  | Default: 0                                                         | No                  |
| contactRequestCount | number    | 총 연락 요청 수          | Default: 0                                                         | No                  |
| newContactRequests  | number    | 미확인 연락 요청 수      | Default: 0                                                         | No                  |
| images              | array     | 사진 URL 배열            | Optional, Max: 3 items                                             | No                  |
| createdAt           | timestamp | 등록 일시                | Not Null                                                           | Yes                 |
| updatedAt           | timestamp | 수정 일시                | Not Null                                                           | No                  |

**Indexes:**

- farmerId + status
- geohash + status + createdAt (composite)
- cropType + status
- status + createdAt

#### Collection: ContactRequests

| Field               | Type      | Description                        | Constraints                                                            | Index |
| ------------------- | --------- | ---------------------------------- | ---------------------------------------------------------------------- | ----- |
| requestId           | string    | 요청 ID (Document ID)              | PK, Auto-generated                                                     | Yes   |
| jobId               | string    | 작업 ID                            | Not Null, FK → Jobs.jobId                                              | Yes   |
| workerId            | string    | 작업자 UID                         | Not Null, FK → UserProfiles.userId                                     | Yes   |
| workerPhone         | string    | 작업자 전화번호                    | Not Null                                                               | No    |
| workerName          | string    | 작업자 닉네임                      | Not Null                                                               | No    |
| workerAvailableFrom | string    | 작업자 통화 가능 시작 시간         | Format: "HH:mm", Not Null                                              | No    |
| workerAvailableTo   | string    | 작업자 통화 가능 종료 시간         | Format: "HH:mm", Not Null                                              | No    |
| workerMessage       | string    | 작업자 메시지                      | Optional, Max: 50 chars                                                | No    |
| workerConsent       | boolean   | 작업자 동의 (항상 true)            | Not Null, Default: true                                                | No    |
| farmerId            | string    | 농부 UID                           | Not Null, FK → UserProfiles.userId                                     | Yes   |
| farmerPhone         | string    | 농부 전화번호 (수락 후 작성)       | Nullable                                                               | No    |
| farmerName          | string    | 농부 닉네임 (수락 후 작성)         | Nullable                                                               | No    |
| farmerAvailableFrom | string    | 농부 통화 가능 시작 시간 (수락 후) | Format: "HH:mm", Nullable                                              | No    |
| farmerAvailableTo   | string    | 농부 통화 가능 종료 시간 (수락 후) | Format: "HH:mm", Nullable                                              | No    |
| farmerConsent       | boolean   | 농부 동의 (수락 시 true)           | Default: false                                                         | No    |
| status              | string    | 요청 상태                          | Enum: 'pending', 'accepted', 'rejected', 'expired', Default: 'pending' | Yes   |
| createdAt           | timestamp | 요청 일시                          | Not Null                                                               | Yes   |
| respondedAt         | timestamp | 농부 응답 일시                     | Nullable                                                               | No    |
| expiresAt           | timestamp | 만료 일시 (생성 + 7일)             | Not Null                                                               | Yes   |

**Indexes:**

- farmerId + status + createdAt (composite) - 농부가 받은 요청 조회
- workerId + jobId (composite, unique) - 중복 방지
- workerId + status - 작업자가 보낸 요청 조회
- status + expiresAt - 만료 처리용

**Business Rules:**

- workerId + jobId는 unique (동일 작업에 1회만 요청)
- 생성 시: workerConsent=true, farmerConsent=false, status='pending'
- 수락 시: farmerPhone/farmerName/farmerAvailable\* 채워짐, farmerConsent=true, status='accepted', respondedAt 기록
- 거절 시: status='rejected'
- 만료: status='expired' (Cloud Function이 7일 후 자동 처리)

#### Collection: Events

| Field     | Type      | Description               | Constraints                                                                                               | Index |
| --------- | --------- | ------------------------- | --------------------------------------------------------------------------------------------------------- | ----- |
| eventId   | string    | 이벤트 ID (Document ID)   | PK, Auto-generated                                                                                        | Yes   |
| eventType | string    | 이벤트 타입               | Enum: 'job_created', 'job_view', 'contact_request_sent', 'contact_accepted', 'contact_rejected', Not Null | Yes   |
| userId    | string    | 발생시킨 사용자 UID       | Not Null                                                                                                  | Yes   |
| jobId     | string    | 관련 작업 ID              | Nullable                                                                                                  | Yes   |
| requestId | string    | 관련 요청 ID              | Nullable                                                                                                  | Yes   |
| timestamp | timestamp | 이벤트 발생 일시          | Not Null                                                                                                  | Yes   |
| metadata  | map       | 추가 정보 (이벤트별 다름) | Optional                                                                                                  | No    |

**Indexes:**

- eventType + timestamp
- userId + eventType + timestamp
- jobId + eventType

**Usage:** 사용자 행동 분석, KPI 측정

#### Collection: Reports

| Field       | Type      | Description           | Constraints                                                  | Index |
| ----------- | --------- | --------------------- | ------------------------------------------------------------ | ----- |
| reportId    | string    | 신고 ID (Document ID) | PK, Auto-generated                                           | Yes   |
| reporterId  | string    | 신고자 UID            | Not Null                                                     | Yes   |
| targetType  | string    | 신고 대상 타입        | Enum: 'job', 'user', 'contact_request', Not Null             | Yes   |
| targetId    | string    | 신고 대상 ID          | Not Null                                                     | Yes   |
| reason      | string    | 신고 사유             | Enum: '허위 정보', '스팸', '부적절한 연락', '기타', Not Null | No    |
| description | string    | 상세 내용             | Optional, Max: 500 chars                                     | No    |
| status      | string    | 처리 상태             | Enum: 'pending', 'reviewed', 'resolved', Default: 'pending'  | Yes   |
| createdAt   | timestamp | 신고 일시             | Not Null                                                     | Yes   |

**Indexes:**

- reporterId + createdAt
- targetType + targetId + status (composite) - 동일 대상 신고 조회
- status + createdAt

### 5.2 Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // UserProfiles
    match /userProfiles/{userId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated() && isOwner(userId) &&
                       request.resource.data.role in ['farmer', 'worker'];
      allow update: if isOwner(userId);
      allow delete: if false; // 삭제는 Cloud Function에서만
    }

    // Jobs
    match /jobs/{jobId} {
      allow read: if true; // 모든 사용자 조회 가능
      allow create: if isAuthenticated() &&
                       request.resource.data.farmerId == request.auth.uid &&
                       request.resource.data.status == 'active';
      allow update: if isAuthenticated() &&
                       isOwner(resource.data.farmerId);
      allow delete: if isOwner(resource.data.farmerId);
    }

    // ContactRequests
    match /contactRequests/{requestId} {
      // 생성: 작업자만 가능
      allow create: if isAuthenticated() &&
                       isOwner(request.resource.data.workerId) &&
                       request.resource.data.workerConsent == true &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.farmerConsent == false;

      // 읽기: 관련 당사자만 (농부 또는 작업자)
      allow read: if isAuthenticated() &&
                     (isOwner(resource.data.workerId) ||
                      isOwner(resource.data.farmerId));

      // 수정: 농부만 (수락/거절)
      allow update: if isAuthenticated() &&
                       isOwner(resource.data.farmerId) &&
                       resource.data.status == 'pending' &&
                       request.resource.data.status in ['accepted', 'rejected'] &&
                       request.resource.data.farmerConsent == true;
    }

    // Events (읽기 금지, 생성만 허용)
    match /events/{eventId} {
      allow read: if false; // 관리자만 조회 (Admin SDK)
      allow create: if isAuthenticated();
    }

    // Reports
    match /reports/{reportId} {
      allow create: if isAuthenticated();
      allow read: if isOwner(resource.data.reporterId);
      allow update: if false; // 수정 불가
    }
  }
}
```

### 5.3 Technology Stack

| Layer                  | Technology                     | Version    | Purpose                                           |
| ---------------------- | ------------------------------ | ---------- | ------------------------------------------------- |
| **Frontend**           | Flutter                        | 3.16+      | iOS/Android 크로스 플랫폼 개발                    |
| **State Management**   | Riverpod\|2.x                  | Latest     | 타입 세이프 상태 관리                             |
| **Backend**            | Firebase                       | -          | BaaS (Backend as a Service)                       |
| **Authentication**     | Firebase Authentication        | -          | 전화번호 인증                                     |
| **Database**           | Cloud Firestore                | -          | NoSQL 문서 데이터베이스                           |
| **Storage**            | Firebase Storage               | -          | 이미지 저장                                       |
| **Cloud Functions**    | Firebase Cloud Functions       | Node.js 18 | 서버리스 백엔드 로직<br>(필수 기능 + 상황별 활용) |
| **Push Notifications** | Firebase Cloud Messaging (FCM) | -          | 푸시 알림                                         |
| **Analytics**          | Firebase Analytics             | -          | 사용자 행동 분석                                  |
| **Crash Reporting**    | Firebase Crashlytics           | -          | 크래시 추적                                       |
| **Maps**               | Google Maps Platform           | -          | 지도 표시 및 위치 기반 서비스                     |
| **Geolocation**        | GeoFlutterFire                 | Latest     | 위치 기반 쿼리                                    |
| **Image Handling**     | image_picker, image            | Latest     | 이미지 선택 및 압축                               |

#### State Management: Riverpod 2.x 선택 이유

| 항목                | 설명                                     |
| ------------------- | ---------------------------------------- |
| **Type Safety**     | 컴파일 타임에 모든 의존성 검증           |
| **Code Generation** | @riverpod 어노테이션 기반 코드 자동 생성 |
| **Dev Tools**       | Riverpod Inspector로 실시간 상태 디버깅  |
| **Testing**         | Provider 오버라이드로 간편한 테스트 작성 |
| **Performance**     | 선택적 리빌드로 불필요한 렌더링 최소화   |

#### Cloud Functions 활용 전략

| 사용 시나리오                 | 필수 여부 | 구현 시기          |
| ----------------------------- | --------- | ------------------ |
| 연락 요청 자동 만료 (API-003) | 필수      | Phase 2            |
| 신고 자동 처리 (API-004)      | 필수      | Phase 2            |
| 푸시 알림 발송 (API-005)      | 필수      | Phase 2            |
| Rate Limiting 서버 검증       | 선택      | Phase 3+ (필요 시) |
| 데이터 분석 배치 작업         | 선택      | Phase 5+ (필요 시) |
| 복잡한 비즈니스 로직          | 선택      | 상황별 판단        |

### 5.4 API Specifications

#### API-001: sendContactRequest

| Attribute      | Details                                                                                                                                                                                                         |
| -------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Type**       | Client-side Firestore Write                                                                                                                                                                                     |
| **Caller**     | 작업자 앱                                                                                                                                                                                                       |
| **Input**      | jobId, workerId, availableFrom, availableTo, message (optional)                                                                                                                                                 |
| **Processing** | 1. 중복 체크 (workerId + jobId)<br>2. Rate Limiting 확인 (하루 20건)<br>3. ContactRequests 문서 생성<br>4. Jobs.contactRequestCount 증가<br>5. Events 로깅<br>6. 농부에게 FCM 푸시 발송 (Cloud Function 트리거) |
| **Output**     | requestId 또는 Error                                                                                                                                                                                            |
| **Errors**     | - ALREADY_SENT: 이미 요청함<br>- RATE_LIMIT_EXCEEDED: 하루 제한 초과<br>- PERMISSION_DENIED: 권한 없음                                                                                                          |

#### API-002: acceptContactRequest

| Attribute      | Details                                                                                                                                                                                                                                                             |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Type**       | Client-side Firestore Update                                                                                                                                                                                                                                        |
| **Caller**     | 농부 앱                                                                                                                                                                                                                                                             |
| **Input**      | requestId, farmerConsent (true)                                                                                                                                                                                                                                     |
| **Processing** | 1. ContactRequests 문서 업데이트<br> - status='accepted'<br> - farmerPhone, farmerName, farmerAvailable\* 추가<br> - farmerConsent=true<br> - respondedAt 기록<br>2. Jobs.newContactRequests 감소<br>3. Events 로깅<br>4. 작업자에게 FCM 푸시 발송 (농부 번호 포함) |
| **Output**     | Success 또는 Error                                                                                                                                                                                                                                                  |
| **Errors**     | - NOT_FOUND: 요청 없음<br>- ALREADY_RESPONDED: 이미 응답함<br>- PERMISSION_DENIED: 권한 없음                                                                                                                                                                        |

#### API-003: expireOldRequests (Cloud Function)

| Attribute      | Details                                                                                             |
| -------------- | --------------------------------------------------------------------------------------------------- |
| **Type**       | Scheduled Cloud Function                                                                            |
| **Trigger**    | 매일 자정 (Cloud Scheduler)                                                                         |
| **Processing** | 1. expiresAt < now인 pending 요청 쿼리<br>2. Batch 업데이트로 status='expired' 설정<br>3. 로그 기록 |
| **Output**     | 만료된 요청 수                                                                                      |

#### API-004: handleReports (Cloud Function)

| Attribute      | Details                                                                                                                                                                               |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Type**       | Firestore Trigger Cloud Function                                                                                                                                                      |
| **Trigger**    | Reports 문서 생성 시                                                                                                                                                                  |
| **Processing** | 1. 동일 대상 신고 수 확인<br>2. 3건 이상 시 자동 조치<br> - user → isActive=false<br> - job → status='deleted'<br> - contact_request → status='rejected'<br>3. 관리자에게 이메일 발송 |
| **Output**     | 조치 결과                                                                                                                                                                             |

#### API-005: sendPushNotification (Cloud Function Helper)

| Attribute      | Details                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| **Type**       | Helper Function                                                                                                              |
| **Input**      | userId, title, body, data                                                                                                    |
| **Processing** | 1. UserProfiles에서 fcmToken 조회<br>2. FCM API 호출<br>3. 실패 시 재시도 (최대 3회)<br>4. 토큰 무효 시 UserProfile 업데이트 |
| **Output**     | Success 또는 Error                                                                                                           |

---
